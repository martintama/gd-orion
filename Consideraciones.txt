TODO!
- Verificar estado de los proveedoers
- Explciar por que pasamos el DNI y CUIT de varchars a int
- Verificar que el CUIT sea valido (en el abm de proveedoreS)
- Inhabilitar usuarios significa NO inhabilitar el login sino solo las funcionalidades que dicen.
- Averiguar si hay que usar verificaicon dinamica en el abm o se puede con los try catch
- Verificar los rangos de fecha de nacimiento contra la BBDD


- Los giftcards no restan credito de quien lo regala

- El nro de cupon es el PK de la tabla de cupones
- Fecha entrega = fecha consumo


Funcionalidades por defecto

Administrativos
. ABM de Cliente
. ABM de Proveedor
. ABM de Rol
. Facturación a Proveedores
. Publicar Cupón
. Listado Estadístico

Clientes
. Cargar Crédito
. Comprar Cupón
. Comprar GiftCard
. Historial de Compra de cupones
. Pedir Devolución

Proveedores
. Armar Cupón
. Registro de consumo de cupon

Accesible desde login:
. Registro de Usuario



 

Roles
- Proveedor
- Administrativo
- Cliente
- (Otros a gusto)

Tablas
-- cargas
-- ciudades
-- clientes
-- clientes_ciudades
-- compras
-- compras_estados
-- consumos
-- cupones
-- cupones_ciudades
-- devoluciones
-- facturas
-- facturas_items
-- funcionalidades
-- gift_cards
-- proveedores
-- roles
roles_funcionalidades
--rubros
-- tarjetas (Se carga a partir de la GUi)
-- tipos_pago
-- tipos_tarjeta
-- usuarios
-- usuarios_tipos



Estrategia:

MIGRACION

Tabla proveedores:
- Se optó por cargar el cuit como campo sin guiones por una cuestion de que a la hora de ingresar el dato es más fácil cargarlo sin guiones que con ellos. (en el registro)
- El campo "email", al no estar presente en la migración, se optó por completarlo con campo '' (vacio). Se barajó la idea de completar con 'No posee' o 'notiene@notiene.com', pero
se descartaron porque ensucian el campo. Preferiblemente dejarlo vacio y se pueda completar posteriormente.
- El campo "contacto" tampoco estaba presente. En este caso se optó por poner como dato '-' (un guión) para simbolizar que no se posee ese dato.
Al migrar la base, los usuarios de los proveedores se generan usando el CUIT como username. La clave inicial en ambos casos es la misma para todos, 123456.

Tabla clientes:
- Al migrar la base, los usuarios de los clientes se generan usando el DNI como username. La clave inicial en ambos casos es la misma para todos, 123456.

Tabla cupones:
- Se consideró en la base maestra se utiliza el mismo código para el cupón que para compras (excluyendo los ultimos dos dígitos), por lo que al migrar se le asigna los primeros 10 caracteres del campo "groupon_codigo" como código de cupón
- Como la fecha de alta (cuando se genera un nuevo cupon) no está en la base, se optó por tomar el dicha fecha como la misma de publicación
- La fecha de vencimiento de canje se tomó como la fecha de vencimiento del cupón más 10 dias, ya que ese fue el máximo intervalo detectado entre vencimiento del cupón y consumo
- La cantidad máxima de cupones por usuario, para aquellos cupones ya en sistema se estableció en 5 (El máximo detectado fue de 3 cupones comprados por usuario)
- La fecha en la que el cupón se publica (por el administrativo) para los que ya están en sistema, se estableció como la de publicación por el proveedor.
- El stock con el que se inicializan los cupones es el campo groupon_cantidad. 

Tabla compras:
- Inicialmente se cargan todos los cupones con el estado "comprado". Una vez que se cargan la tabla de devoluciones y consumos, se actualiza dicho estado según corresponda.
- Se detectaron inconsistencias en los códigos de compra de los cupones. Si bien en el enunciado figura que los códigos son POR COMPRA, en la base se encontraron compras del mismo cupón, 
por diferentes usuarios, con el mismo código. Tal es el caso de la compra con código: AAADWZLCSP12, que fue comprada por ERVAR Ferreyra (DNI 48357541) y CEFERINO Silva (DNI 86345376).
En estos casos se optó por mantener la compatibilidad hacia atras, migrando los datos como están, pero asegurando que a futuro dicho código sea realmente por compra.

- Para todos los cupones que hayan quedado como "comprado", se setearon como "vencidos" todos los cupones que se hayan comprado hasta el 26/12/2009. Esto se hizo así para mantener 
la coherencia de vencimiento a los 5 dias de la compra: Como el cupón comprado más "recientemente" es del 31/12/2009, se asume que hoy es 01/01/2010 
(Tomamos como consideración que si fuera otra fecha más reciente, habría más registros de esas fechas. Como no lo podemos comprobar, lo suponemos).
- Luego de completadas las tablas de consumos, compras y devoluciones, se actualiza el stock de cada cupón para que guarden coherencia con las tablas de consumos y devoluciones:
	cantidad_final = cantidad_inicial - cantidad_cupones_entregados - cantidad_cupones_comprados (sin canjear)
	los cupones devueltos y y vencidos no restan del stock ya que son cupones que no fueron consumidos

Tabla devoluciones:
- Como el motivo no estaba en la tabla maestra, se cargaron todas las devoluciones existentes como "- no especifica (migración inicial) -"


-- GUI


Logueo.

Se ingresan el usuario y password. Se verifica si todos los datos están completos y se devueve un return_status el que puede ser:

0 - Todo OK: Logueo
1 - Usuario o password incorrecto
2 - Falta completar usuario o password
3 - Usuario inhabilitado

General

Conexiones a la base se genera una nueva cada vez que se realiza una transaccion. Se utiliza una conexion global.


Roles

No se permite deshabilitar un rol que este asociado aún a un usuario. Esto se efectiviza utilizando un stored procedure que devuelva un 0 si no hubo problemas, o un 1 si no se pudo
inhabilitar porque hay usuarios asociados.

En este caso se consulta al usuarios si desea continuar deshabilitando también los usuarios y solo así se puede deshabilitar el rol.

ABM de clientes:

- El DNI además de ser numérico debe ser entre 1000000 y 99999999
- Se realiza una verificación de que la dirección de correo es válida, pero solo se hace una comprobación estandar. Las direcciones según el RFC correspondiente pueden ser de lo
	más variadas. Una página lo explica: http://haacked.com/archive/2007/08/21/i-knew-how-to-validate-an-email-address-until-i.aspx
	La dirección !def!xyz%abc@example.com es válida según la especificación.
	Se adaptó el método de la siguiente dirección: http://www.dreamincode.net/code/snippet1374.htm
- La fecha de nacimiento debe estar entre 01/01/1900 y 31/12/2050	
- Seleccion de ciudades:

Se consideró la opción de usar la "Selección por buscador" tal cual se especifica en la GUIA DE ABMs,
pero se descartó por no ser cómoda a la hora de elegir más de una ciudad.
También se consideró la idea de realizar un formulario con checkboxes fijos, uno para
cada ciudad, pero si bien las ciudades no se pueden modificar, no nos pareció correcto 
ya que limita mucho el diseño (Si se insertara una ciudad nueva que comience con A, como se 
encuentran odenados alfabeticamente, habría que mover casi todos los checkboxes para abajo.
Finalmente se decidió por la idea de tener dos listas, una de ciudades seleccionadas y otra de
ciudades disponibles. Similar a cómo se seleccionan las funcionalidades en los roles ya que
conserva la facilidad de uso y la flexibilidad.

	- Grabar datos
	A la hora de grabar datos, se verifica que no exista el usuario, tanto activo como inactivo. Esto es así
	porque podria suceder que un usuario inhabilitado se vuelva a habilitar por parte del administrativo
	
	Se verifica además que no exista otro cliente con el mismo teléfono o DNI. Esas son los datos que es verifican
	para asegurar que no se da el caso que un cliente se loguea con más de un usuario.
	
	- La carga inicial de $10 se realiza con el medio de pago "Sistema", para diferenciarla de las cargas que realiza el cliente
	
- Cada funcionalidad está relacionada con un tipo de usuario en especial por defecto, y esto no es posible modificarlo. Según lo solicita el enunciado, es posible crear nuevos roles y asignarle funcionalidades,
pero si se le asigna una funcionalidad incompatible con el tipo de usuario de "base", se mostrará el item en el menú principal pero no será posible acceder a el (aparecerá un mensaje diciendo "Para utilizar esta funcionalidad usted debe ser X" (Ej. Cliente).
Esto se hizo de esta manera para prevenir errores por incompatibilidad de Sesion logueada. (de allí se toman datos como idproveedor, por ejemplo, que siendo un cliente no se posee)

ABM de proveedores
- Para buscar todos los CUIT, se carga -1 porque es un valor que no se podrá cargar manualmente.

Cargar crédito:
- Los medios de pago posibles son efectivo o tarjeta de crédito.
- En caso de elegir tarjeta de crédito, se deben completar los siguientes datos:
	- Marca (Visa, Mastercard, AMEX)			Selección acotada
	- Titular (tal cual figura en la tarjeta)	
	- DNI Titular				(Max 8 caracteres)
	- Nro de tarjeta			
	- Código de seguridad		
	- Año vencimiento			(Seleccion especial mediante Numericupdown)
	- Mes vencimiento			(Seleccion especial mediante Numericupdown)
	
Tomamos estos datos porque son los datos que se piden al realizar transacciones por internet en la vida real.

Al cargar el formulario, el año de vencimiento se setea con un mínimo que es el año actual (del archivo de configuración). Esto es para que no se pueda ingresar un año anterior al actual e invalido. El mes por defecto se deja el corriente.

Verificamos si la tarjeta es AMEX y validamos que el largo de la tarjeta sea de 15 dígitos y el código de seguridad sea de 4 dígitos. Caso contrario (VISA, MASTERCARD), debe ser de 16 dígitos y 3 los dígitos de seguridad

Al cargar crédito con tarjeta, almacenamos los datos correspondientes a la tarjeta de crédito junto a la carga. Si la tarjeta no existe, previamente se inserta y se continua con la inserción del registro en la tabla de cargas.


Comprar GiftCard
- Si bien en la base existente hay giftcard con todos los valores entre 25 y 99, se estipuló que a partir de la migración el monto no sea tan libre sino acotado entre { $25, $30, $50, $75 y $100 }.
- En la selección por busqueda, el cliente logueado se omite de los resultados para evitar que se autocompren una giftcard.
- En esta misma selección por busqueda, se omiten todos los clientes inhabilitados.
- Las compras de giftcards se cargan como cargas de credito para los usuarios destinatarios con el tipo de pago "Gift Card".

Publicar Cupón:
	- Las fechas de publicación, vencimiento de promoción y vencimiento de canje deben estar separadas por un día entre ellas mínimamente.

Comprar Cupón:
- En la lista de cupones para comprar, no se muestran los cupones de los proveedores inhabilitados. Esto se hizo así debido a que de mostrarlos, el cliente lo podría comprar y consumir, pero el proveedor
no podría registrarlo. De esta forma no podria tampoco facturarle al proveedor.
- El código utilizado para identificar cada compra es por ejemplo: C00123400004. Esto se descompone en:

1- Letra "C"	 (fijo)
2- Idcupon 		 (Con ceros delante para completar la longitud de 6 dígitos)
3- nro de compra del cupón (Con ceros delante para completar una longitud de 5 dígitos)

De esta forma nos aseguramos de que los códigos son únicos e irrepetibles. Este código se genera en el SP encargado de cargar la compra.

- Para calcular la cantidad de cupones que un mismo cliente puede comprar, contemplamos unicamente los cupones comprados/canjeados. No tenemos en cuenta los cupones que el cliente puede haber comprado y posteriormente devuelta en los calculos.
Esto quiere decir además que si un cupón tiene un máximo de 2 cupones por persona, no es posible burlar la limitación comprando primero dos cupones y luego uno aparte.
- El botón limpiar blanquea los campos, y recarga los cupones del día. Se omiten aquellos que ya no tienen stock disponible.

Devoluciones
	- Los cupones devueltos vuelven a figurar en el stock del proveedor.
	- CUando se ingresa un código inválido, ya sea porque el código no existe o no pertenece al cliente, el mensaje de error que recibe el usuario es el mismo: "Código inválido". Esto se hace así
	para no revelar información que podría ser de otro cliente.

Registrar consumo	
	- Cuando se ingresa un código inválido, aquí sí se diferencia si es un código inexistente o si no pertenece al proveedor. Esto se hace así para poder avisar al cliente que el código es válido, pero que
	debe corroborar de vuelta el proveedor.
	- El proveedor debe confirmar que el DNI del cliente corresponde con el DNI de quien lo va a retirar. Debe tildar el casillero de "DNI Verificado" antes de continuar. 
	
Historial de compra
- Por defecto se buscan los cupones comprados en el ultimo més (ej. del 23 de noviembre al 23 de diciembre). 
- El botón limpiar resetea el listado a dicho intervalo.

Facturar proveedor
- Se debe completar un rango de fechas y el proveedor. Al presionar "buscar" se muestran todos los consumos disponibles para facturas. La factura se genera luego de presionar el boton de "Generar". 
Alli, se setean como facturados todos los consumos, se genera la factura y se cargan los items. Todo esto se realiza en un Stored Procedure en la base.

Estadisticas
- Para el reporte de devoluciones, se traen los 5 proveedores que tuvieron más cantidad de devoluciones de cupones, y entre ellos se ordena por monto (esto se hace por el enunciado que dice "El listado se debe ordenar en forma descendiente por monto"